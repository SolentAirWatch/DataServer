<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head>
  
  <meta content="text/html; charset=ISO-8859-1" http-equiv="content-type">
  <title>Test Page</title>

  
</head><body>
<table style="text-align: left; width: 1157px; height: 776px;" border="0" cellpadding="2" cellspacing="2">

  <tbody>
    <tr>
      <td style="vertical-align: top; width: 743px;"><img style="width: 901px; height: 704px;" alt="" src="file:///Users/bob/Google%20Drive/Southampton%20Pollution/Outreach/003%20-%20TEC%20SCC%20-%20National%20Clean%20Air%20Day/visuliser/Soton_Map.png"><br>
      </td>
      <td style="vertical-align: top; width: 743px;">2<br><table style="text-align: left; width: 100%;" border="1" cellpadding="2" cellspacing="2"><tbody><tr><td style="vertical-align: top;"><br>
<iframe src="https://www.youtube.com/embed/D6Ac5JpCHmI?&amp;autoplay=1" allowfullscreen="" frameborder="0" height="315" width="560"></iframe>
</td></tr><tr><td style="vertical-align: top;"><br>
<iframe src="https://www.youtube.com/embed/D6Ac5JpCHmI?&amp;autoplay=1" allowfullscreen="" frameborder="0" height="315" width="560"></iframe>
</td></tr></tbody></table><br>
      </td>
    </tr>
    <tr>
      <td id="chart_container" style="vertical-align: top; width: 743px;"><br>
      </td>
      <td style="vertical-align: top; width: 743px;">4<br>
</td>
      
    </tr>
  </tbody>
</table>

<br>

<br>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.bundle.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script>

var drawScalingFactor = 40;

var maxDataPointsInCharts = 100;

var number_of_sensors = 2;

//this function makes a chart with name "id".

function make_chart(id) {
  var chart = new Chart(id, {
    type: 'line',
    data: {
      datasets: []
    },
    options: {
      scales: {
	xAxes: [{
	  type: 'time',
	  ticks: {
	    autoSkip: false,
	    maxRotation: 0,
	    minRotation: 0
	  },
	  // position: 'bottom',
	  time: {
	    displayFormats: {
	      'millisecond': 'HH:MM:SS',
	      'second': 'HH:MM:SS',
	      'minute': 'HH:MM:SS',
	      'hour': 'HH:MM:SS',
	      'day': 'HH:MM:SS',
	      'week': 'HH:MM:SS',
	      'month': 'HH:MM:SS',
	      'quarter': 'HH:MM:SS',
	      'year': 'HH:MM:SS'
	    }
	  }
	}],
	yAxes: [{
	  display: true,
	  ticks: {
	    beginAtZero: true,// minimum value will be 0. 
	    suggestedMax: 2000
	  }
	}]
      },
      maintainAspectRatio: false,
      animation: false,
      legend: { display: false }
    }
  });
  chart.name = id;
  chart.buffers = [];
  return chart;
}


var pmChartBySid = {};


window.addEventListener("load", function() {
  // make pm charts by sid
  var chartsContainer = document.getElementById("chart_container");

  //each chart gets a div with text etc
  //for loop here is replaced so only get one copy

  for (var i=1;i<=1;i++) {
    var el = document.createElement("div");
    el.className="chart";

    // sensor ID text
    var txt = document.createElement("div");
    txt.className = "chart_text";
    txt.innerText = "West Quay";
    el.appendChild(txt);

    // canvas
    var canvas = document.createElement("canvas");
    el.appendChild(canvas);
    canvas.className="chart_canvas";
    canvas.id = "chart_canvas";
    chartsContainer.appendChild(el);
  }
  //add a single chart
    for (var i=1;i<=1;i++) {
      pmChartBySid[i] = {
	"chart": make_chart("sensor_chart"),
	"domid": "chart_canvas",
	"dataset": null,
	"timeout": null,
	"name": "PM"
      }
    }
});
//set up the event listener
//so that we know when we first receive data
var firstevent = 1;
//TODO: add token code
var eventUrl = new EventSource("https://realtime.opensensors.io/v1/events/users/solentairwatch/topics?token=eyJhbGciOiJBMjU2S1ciLCJ0eXAiOiJKV0UiLCJlbmMiOiJBMTI4R0NNIn0.ZcFSUNBeecJsEKWdKqKYmdMzc8J4X3_k.1Wa98DQw0w9IDL-W.NDwYfREP9QOw7d9y6cexIqc8A6lJVYq6qXMm4g2xpdY0fB7eHc8hhb-4A7BR7qjwTHd75ccYPL4tck_NmZ4GCYdfxXGxI3V4HOmG0P8JIf7ifyqsyURpBGZ66tXyi6_lDQ8LAYuV6EwGQkrL9r8wy8BDPGX_OUr-2QivBwo8bEApz9A5MasjMChWwNaH_DpTOMSIUh9vMMww1wgkHfk.azwX6g3SQXWtK-amSgAtrw");
eventUrl.onmessage = function(event) {
  console.log(event.data);
  if ( firstevent == 1 ) {
    //this code runs if this is the first event
    firstevent = 0;
    processinitialdatachart("pm", 1, event.data);
  } else {
    //update data
  processStreamDataChart("pm", event.data);
  }
}

// message is an array of objects, e.g. [{timestamp: "2017-03-12", etc...}, ...]
function processInitialDataChart(sensor_name, sid, message) {
  var sensor = plottableSensorData[sensor_name];
  var sids_to_update = [];
  for (var readingName in sensor) {
    var dataXy = message.map(function(d) {
      return {x: d.timestamp, y: d[readingName]};
    });
    sids_to_update.push(sid);
    var dataset = getOrCreateDataset(sensor_name, sid, readingName);
    dataset.data = dataXy;
  }

  // update all charts
  done = {};
  sids_to_update.every(function(sid) {
    if (done[sid]) { return true; }
    done[sid] = true;
    pmChartBySid[sid].chart.update(200, false);
    return true;
  });
}

function processStreamDataChart(sensor_name, message) {
  //update the charts
  var sensor = plottableSensorData[sensor_name];
  for (var readingName in sensor) {
    getOrCreateDataset(sensor_name, message._sid, readingName);
    var datapoint = {x: message.timestamp, y: message[readingName]};
    addDataPoint(sensor_name, message._sid, readingName, datapoint);
  }
}

function addDataPoint(sensorName, sid, readingName, point) {
  var cfg = pmChartBySid[sid];
  cfg.buffer.push(point);
  requestRender(cfg);
}

function requestRender(cfg) {
  // update all charts
  if (cfg.timeout !== null) {
    // do nothing, there's a timeout already
    return
  }

  // there is no timeout, so set one
  cfg.timeout = setTimeout(function(){
    console.log("rendering", cfg.name, cfg);

    var chart = cfg.chart;

    var buffer = cfg.buffer;
    var dataset = cfg.dataset;

    var data = dataset.data.slice();
    for (var j in buffer) {
      data.push(buffer[j]);
    }

    buffer.length = 0;
    if (data.length > maxDataPointsInCharts) {
      data = data.slice(data.length - maxDataPointsInCharts);
    }

    dataset.data = data;

    chart.update(0, false);
    cfg.timeout = null;

  }, 500);
}

// chart is a chart object, sensor_name is "bmp", "pm" or "a4",
// stream_name is for example "PM25_STD"
function getOrCreateDataset(sensor_name, sid, stream_name) {
  var cfg = pmChartBySid[sid];
  var chart = cfg.chart;

  if (cfg.dataset !== undefined && cfg.dataset !== null) {
    return cfg.dataset;
  }

  // for (var i in chart.data.datasets) {
  //var dts = chart.data.datasets[i];
  //if (dts.label == stream_name) {
  //return chart.data.datasets[i];
  //}
  // }

  // if not found (didn't return in the for loop)
  var dts = {
    data: [],
    label: cfg.displayName || stream_name,
    borderColor: cfg.color || "#000000",
    backgroundColor: "transparent",
    bezierCurve : false,
    fill: false,
    lineTension: 0,
    cubicInterpolationMode: "monotone"
  };

  cfg.dataset = dts;
  cfg.buffer = [];
  chart.data.datasets.push(dts);
  return dts;
}
	</script>
</body></html>
